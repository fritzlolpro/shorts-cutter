# Shorts Cutter — CLI для пакетной ffmpeg-обработки видео

## Цель
Утилита для пакетной обработки видеофайлов (шортсов) с помощью заданной ffmpeg-команды, с многопоточностью, логированием и контролем ошибок. Реализация на Rust, CLI-интерфейс.

---

## Требования

### Основная функциональность
- Перебор всех `.mp4` файлов в выбранной пользователем папке-источнике.
- Для каждого файла запуск заранее заданной команды ffmpeg (маска команды жёстко задана).
- Выходные файлы сохраняются в указанную пользователем папку-вывод.
- Имя выходного файла по умолчанию: `<source_name>-short.mp4`.
- По завершению — вывод в консоль списка успешно обработанных файлов и файлов с ошибками.

### CLI-интерфейс
- Аргументы:
  - `--input`, `-i` — путь к папке с исходными файлами (обязательно).
  - `--output`, `-o` — путь к папке для результатов (обязательно).
  - `--threads`, `-t` — количество параллельных задач (опционально; по умолчанию — все доступные ядра).
  - `--help`, `-h` — справка (также выводится при ошибке в параметрах).
- Все ошибки и статус операции логируются в файл в папке вывода.
- Имя лог-файла: по времени запуска программы (`shorts-cutter-YYYYMMDD-HHMMSS.log`). В будущем предусмотреть возможность задания имени лог-файла явно (через аргумент, пока не реализовывать).

### Многопоточность
- Параллельная обработка файлов, количество потоков ограничивается параметром `--threads` (по умолчанию — auto).
- Реализация worker pool на базе tokio.

### Логирование
- Один общий лог-файл в папке вывода.
- В лог заносится: имя обрабатываемого файла, итог (успех/ошибка), сообщение об ошибке (если была), параметры запуска ffmpeg, таймстемп.
- В конце работы программа выводит в консоль итоговый отчёт: список успешно обработанных файлов и файлов с ошибками.

### Проверка ffmpeg
- До старта обработки программа проверяет, доступен ли ffmpeg в PATH.
- При отсутствии ffmpeg — выводит в stderr сообщение и завершает работу.

### Поведение при ошибках
- Ошибка обработки одного файла не мешает обработке других.
- Все ошибки и детали заносятся в лог.
- Итоговые списки ошибок/успехов отражаются в отчёте после завершения обработки.

### Дополнительно
- Сохранять параметры запуска ffmpeg для каждого файла в лог-файл.
- В будущем предусмотреть возможность настройки шаблона имени выходного файла и имени лог-файла через параметры командной строки.

---

## Пример использования

```sh
shorts-cutter --input ./clips --output ./shorts --threads 4
```

---

## Пример строки ffmpeg (захардкожена в программе)

```sh
ffmpeg -i <infile> -i <infile> -filter_complex "[0:v]scale=2276:1280,boxblur=4[bg];[1:v]scale=720:-1[fg];[bg][fg]overlay=(W-w)/2:(H-h)/2[tmp];[tmp]crop=720:1280:(2276-720)/2:0[out]" -map "[out]" -map 0:a <outfile>
```

---

## Пример формата лог-файла

```
[2025-07-22 12:34:56] START processing 05JUN2025-00.07.14.027-00.07.41.838-seg2.mp4
[2025-07-22 12:34:56] CMD: ffmpeg -i ...
[2025-07-22 12:35:20] SUCCESS: 05JUN2025-00.07.14.027-00.07.41.838-seg2.mp4 -> 05JUN2025-00.07.14.027-00.07.41.838-seg2-short.mp4
[2025-07-22 12:35:21] START processing 13JUN2025-00.17.14.027-00.17.41.838-seg2.mp4
[2025-07-22 12:35:21] CMD: ffmpeg -i ...
[2025-07-22 12:35:45] ERROR: 13JUN2025-00.17.14.027-00.17.41.838-seg2.mp4 -> 13JUN2025-00.17.14.027-00.17.41.838-seg2-short.mp4
[2025-07-22 12:35:45] ERRMSG: ffmpeg exited with code 1: [текст ошибки ffmpeg]
...
```

---

## Архитектура (модули)

- Аргументы командной строки (clap/reedline/structopt)
- Поиск и перебор файлов
- Асинхронный запуск ffmpeg (tokio + worker pool)
- Логирование (один log-файл)
- Отчёт по завершению

---

## Ограничения

- Нет ограничений на размер/количество файлов.
- Программа не должна падать при ошибках отдельных файлов.